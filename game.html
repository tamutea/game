<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>äººç”Ÿã‚²ãƒ¼ãƒ ç›¤é¢ï¼ˆ5äººãƒ—ãƒ¬ã‚¤ï¼‰</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(14, 40px); /* åˆ—æ•°ã¯ã‚ãªãŸã®ç›¤é¢ã«åˆã‚ã›ã¦èª¿æ•´OK */
    grid-auto-rows: 40px;
    gap: 4px;
    margin: 20px auto;
    background: #f5f5f5;
    padding: 10px;
  }
  .cell {
    border: 1px solid #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: #fff;
    font-size: 10px;
    position: relative;
  }

  .players-badge {
  position: absolute;
  top: 0px;       /* â† ãƒã‚¹ã®ä¸Šå´ã«é…ç½® */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 2px;
}

  .player-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }
  .p0 { background:#ffcc00; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 */
  .p1 { background:#00ccff; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 */
  .p2 { background:#ff66cc; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3 */
  .p3 { background:#66ff66; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4 */
  .p4 { background:#ff6666; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5 */

  img {
    max-width: 80%;
    max-height: 40%;
  }
  button {
    margin: 10px;
    padding: 10px;
    font-size: 16px;
  }
  
  @keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0; }
  100% { opacity: 1; }
}

#loseImg.blink {
  animation: blink 0.09s infinite;
}

@keyframes popupFade {
  0% { opacity: 0; transform: scale(0.7); }
  100% { opacity: 1; transform: scale(1); }
}

#cellPopup.show {
  animation: popupFade 0.3s ease-out;
}


</style>
</head>
<body>

  <div id="setupPanel" style="padding:20px;">
  <h2>ãƒã‚¹å†…å®¹ã®äº‹å‰è¨­å®š</h2>

  <h3>æ–‡ç« ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ50å€‹ï¼‰</h3>
  <div id="textSlots"></div>

  <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
  <input type="file" id="imgInput" accept="image/*" multiple>
  <div id="imgList" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div>

  <button id="startGameBtn" style="margin-top:20px;">æ±ºå®šã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹</button>
</div>

<div id="cellPopup" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,0.85);
  z-index:9999;
  text-align:center;
  padding:20px;
  box-sizing:border-box;

  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
">
  <div id="popupText" style="margin-bottom:20px; font-size:28px; color:white; max-width:90vw;"></div>
  <img id="popupImg" src="" style="max-width:90vw; max-height:50vh; display:none; margin-bottom:20px;">
  <button onclick="closeCellPopup()" style="font-size:24px; padding:10px 20px;">é–‰ã˜ã‚‹</button>
</div>


<div id="losePopup" style="
  display:none;                 /* â† ã“ã‚Œã ã‘ã§OK */
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,0.85);
  z-index:99999;
  text-align:center;
  padding:20px;
  box-sizing:border-box;
">
  <div style="
    width:100%;
    height:100%;
    display:flex;               /* â† ã“ã£ã¡ã« flex ã‚’ç§»å‹• */
    flex-direction:column;
    justify-content:center;
    align-items:center;
  ">
    <h2 style="color:red; font-size:40px; margin-bottom:20px;">æ•—åŒ—â€¦</h2>

    <img id="loseImg" src="" style="
      max-width:90vw;
      max-height:50vh;
      margin-bottom:20px;
    ">

    <button onclick="location.reload()" style="
      font-size:24px;
      padding:10px 20px;
    ">ã‚²ãƒ¼ãƒ ã‚’ã‚„ã‚Šç›´ã™</button>
  </div>
</div>



<div id="videoPopup" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  z-index:99999;
  justify-content:center;
  align-items:center;
">
  <video id="eventVideo" width="80%" controls></video>
</div>


<h1>äººç”Ÿã‚²ãƒ¼ãƒ ï¼ˆ5äººãƒ—ãƒ¬ã‚¤ç‰ˆï¼‰</h1>
<div id="turnInfo"></div>
<div id="board"></div>
<button onclick="rollDice()">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
<button onclick="rollReverseDice()">é€†ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
<button onclick="exportData()">æ–‡ç« ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™</button>
<input type="file" onchange="importData(event)">
<p id="status">ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã§ã™ã€‚</p>
<img id="diceImg" src="dice1.png" width="80">

<script>
const TYPE_START    = "start";
const TYPE_NORMAL   = "normal";
const TYPE_BRANCH   = "branch";
const TYPE_WARP_TO  = "warpTo";
const TYPE_WARP_FROM= "warpFrom";
const TYPE_ONEWAY   = "oneway";
const TYPE_GOAL     = "goal";

function col(c){ return c.charCodeAt(0)-64; }

/* â˜…â˜…â˜… ã“ã“ã«ã€Œã„ã¾å‹•ã„ã¦ã„ã‚‹ board é…åˆ—ã€ã‚’ãã®ã¾ã¾è²¼ã‚‹ â˜…â˜…â˜…
   ï¼ˆA1ã€œF23 ã¾ã§ã€ã‚ãªãŸãŒã™ã§ã«å‹•ä½œç¢ºèªã—ãŸã‚‚ã®ï¼‰
   ä¾‹ï¼š
   let board = [
     {id:"A1",label:"ã‚¹",type:TYPE_START,row:1,col:col("A"),next:["A2"],text:""},
     ...
   ];
*/
let board = [/* â†ã“ã“ã‚’ã‚ãªãŸã®ç¾è¡Œ board å®šç¾©ã§åŸ‹ã‚ã‚‹ */  // A1ã€œA7
  {id:"A1",label:"ã‚¹",type:TYPE_START,row:1,col:col("A"),next:["A2"],text:"", move:0},
  {id:"A2",label:"â—‹",type:TYPE_NORMAL,row:2,col:col("A"),next:["A3"],text:"", move:0},
  {id:"A3",label:"â—‹",type:TYPE_NORMAL,row:3,col:col("A"),next:["A4"],text:"", move:0},
  {id:"A4",label:"â—‹",type:TYPE_NORMAL,row:4,col:col("A"),next:["A5"],text:"", move:0},
  {id:"A5",label:"â—‹",type:TYPE_NORMAL,row:5,col:col("A"),next:["A6"],text:"", move:0},
  {id:"A6",label:"â—‹",type:TYPE_NORMAL,row:6,col:col("A"),next:["A7"],text:"", move:0},
  {id:"A7",label:"â—‹",type:TYPE_NORMAL,row:7,col:col("A"),next:["A8"],text:"", move:0},

  // A8 åˆ†å²â‘ 
  {id:"A8",label:"â—",type:TYPE_BRANCH,row:8,col:col("A"),next:["B8","A9"],text:"åˆ†å²1", move:0},

  // A8 â†’ å³ãƒ«ãƒ¼ãƒˆ â†’ H11
  {id:"B8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("B"),next:["C8"],text:"", move:0},
  {id:"C8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("C"),next:["D8"],text:"", move:0},
  {id:"D8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("D"),next:["E8"],text:"", move:0},
  {id:"E8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("E"),next:["F8"],text:"", move:0},
  {id:"F8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("F"),next:["G8"],text:"", move:0},
  {id:"G8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("G"),next:["H8"],text:"", move:0},
  {id:"H8",label:"â—‹",type:TYPE_NORMAL,row:8,col:col("H"),next:["H9"],text:"", move:0},
  {id:"H9",label:"â—‹",type:TYPE_NORMAL,row:9,col:col("H"),next:["H10"],text:"", move:0},
  {id:"H10",label:"â—‹",type:TYPE_NORMAL,row:10,col:col("H"),next:["H11"],text:"", move:0},

  // ä¸€æ–¹é€šè¡Œ H11
  {id:"H11",label:"â–²",type:TYPE_ONEWAY,row:11,col:col("H"),next:["I11"],text:"ä¸€æ–¹é€šè¡Œ", move:0},

  // A8 â†’ ä¸‹ãƒ«ãƒ¼ãƒˆ â†’ H11 ã«åˆæµ
  {id:"A9",label:"â—‹",type:TYPE_NORMAL,row:9,col:col("A"),next:["A10"],text:"", move:0},
  {id:"A10",label:"â—‹",type:TYPE_NORMAL,row:10,col:col("A"),next:["A11"],text:"", move:0},
  {id:"A11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("A"),next:["A12"],text:"", move:0},
  {id:"A12",label:"â—‹",type:TYPE_NORMAL,row:12,col:col("A"),next:["A13"],text:"", move:0},
  {id:"A13",label:"â—‹",type:TYPE_NORMAL,row:13,col:col("A"),next:["A14"],text:"", move:0},
  {id:"A14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("A"),next:["B14"],text:"", move:0},

  {id:"B14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("B"),next:["C14"],text:"", move:0},
  {id:"C14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("C"),next:["D14"],text:"", move:0},
  {id:"D14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("D"),next:["E14"],text:"", move:0},
  {id:"E14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("E"),next:["F14"],text:"", move:0},
  {id:"F14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("F"),next:["G14"],text:"", move:0},
  {id:"G14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("G"),next:["H14"],text:"", move:0},
  {id:"H14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("H"),next:["H13"],text:"", move:0},
  {id:"H13",label:"â—‹",type:TYPE_NORMAL,row:13,col:col("H"),next:["H12"],text:"", move:0},
  {id:"H12",label:"â—‹",type:TYPE_NORMAL,row:12,col:col("H"),next:["H11"],text:"", move:0},

  // â— ãƒ¯ãƒ¼ãƒ—å…ˆ C11 ã‹ã‚‰ H11 ã¾ã§æ¨ªã«é€²ã‚€
  {id:"C11",label:"â—",type:TYPE_WARP_TO,row:11,col:col("C"),next:["D11"],text:"ãƒ¯ãƒ¼ãƒ—å…ˆ", move:0},
  {id:"D11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("D"),next:["E11"],text:"", move:0},
  {id:"E11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("E"),next:["F11"],text:"", move:0},
  {id:"F11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("F"),next:["G11"],text:"", move:0},
  {id:"G11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("G"),next:["H11"],text:"", move:0},

  // H11 â†’ M11
  {id:"I11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("I"),next:["J11"],text:"", move:0},
  {id:"J11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("J"),next:["K11"],text:"", move:0},
  {id:"K11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("K"),next:["L11"],text:"", move:0},
  {id:"L11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("L"),next:["M11"],text:"", move:0},
  {id:"M11",label:"â—‹",type:TYPE_NORMAL,row:11,col:col("M"),next:["M12"],text:"", move:0},

  // M11 â†’ M19
  {id:"M12",label:"â—‹",type:TYPE_NORMAL,row:12,col:col("M"),next:["M13"],text:"", move:0},
  {id:"M13",label:"â—‹",type:TYPE_NORMAL,row:13,col:col("M"),next:["M14"],text:"", move:0},
  {id:"M14",label:"â—‹",type:TYPE_NORMAL,row:14,col:col("M"),next:["M15"],text:"", move:0},
  {id:"M15",label:"â—‹",type:TYPE_NORMAL,row:15,col:col("M"),next:["M16"],text:"", move:0},
  {id:"M16",label:"â—‹",type:TYPE_NORMAL,row:16,col:col("M"),next:["M17"],text:"", move:0},
  {id:"M17",label:"â—‹",type:TYPE_NORMAL,row:17,col:col("M"),next:["M18"],text:"", move:0},
  {id:"M18",label:"â—‹",type:TYPE_NORMAL,row:18,col:col("M"),next:["M19"],text:"", move:0},
  {id:"M19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("M"),next:["L19"],text:"", move:0},

  // M19 â†’ F19
  {id:"L19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("L"),next:["K19"],text:"", move:0},
  {id:"K19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("K"),next:["J19"],text:"", move:0},
  {id:"J19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("J"),next:["I19"],text:"", move:0},
  {id:"I19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("I"),next:["H19"],text:"", move:0},
  {id:"H19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("H"),next:["G19"],text:"", move:0},
  {id:"G19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("G"),next:["F19"],text:"", move:0},
  {id:"F19",label:"â—‹",type:TYPE_NORMAL,row:19,col:col("F"),next:["F20"],text:"", move:0},

  // â–³ ãƒ¯ãƒ¼ãƒ—å…ƒ F20ï¼ˆæ­¢ã¾ã£ãŸã¨ãã ã‘ C11 ã¸ãƒ¯ãƒ¼ãƒ—ï¼‰
  // é€šå¸¸ã®é€²è¡Œã¨ã—ã¦ã¯ F21 ã¸é€²ã‚€
  {id:"F20",label:"â–³",type:TYPE_WARP_FROM,row:20,col:col("F"),next:["F21"],text:"ãƒ¯ãƒ¼ãƒ—å…ƒ", move:0},


// ã“ã“ã‹ã‚‰ä¸‹ã€F21 ä»¥é™ã‚’å·®ã—æ›¿ãˆ

// åˆ†å²â‘¡ F21
{id:"F21",label:"â—",type:TYPE_BRANCH,row:21,col:col("F"),next:["G21","E21"],text:"åˆ†å²2", move:0},

// å³ãƒ«ãƒ¼ãƒˆï¼šF21 â†’ I21
{id:"G21",label:"â—‹",type:TYPE_NORMAL,row:21,col:col("G"),next:["H21"],text:"", move:0},
{id:"H21",label:"â—‹",type:TYPE_NORMAL,row:21,col:col("H"),next:["I21"],text:"", move:0},
{id:"I21",label:"â—‹",type:TYPE_NORMAL,row:21,col:col("I"),next:["I22"],text:"", move:0},

// å³ãƒ«ãƒ¼ãƒˆï¼šI21 â†’ I29ï¼ˆä¸‹ã¸ï¼‰
{id:"I22",label:"â—‹",type:TYPE_NORMAL,row:22,col:col("I"),next:["I23"],text:"", move:0},
{id:"I23",label:"â—‹",type:TYPE_NORMAL,row:23,col:col("I"),next:["I24"],text:"", move:0},
{id:"I24",label:"â—‹",type:TYPE_NORMAL,row:24,col:col("I"),next:["I25"],text:"", move:0},
{id:"I25",label:"â—‹",type:TYPE_NORMAL,row:25,col:col("I"),next:["I26"],text:"", move:0},
{id:"I26",label:"â—‹",type:TYPE_NORMAL,row:26,col:col("I"),next:["I27"],text:"", move:0},
{id:"I27",label:"â—‹",type:TYPE_NORMAL,row:27,col:col("I"),next:["I28"],text:"", move:0},
{id:"I28",label:"â—‹",type:TYPE_NORMAL,row:28,col:col("I"),next:["I29"],text:"", move:0},
{id:"I29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("I"),next:["H29"],text:"", move:0},

// å³ãƒ«ãƒ¼ãƒˆï¼šI29 â†’ F29ï¼ˆå·¦ã¸ï¼‰
{id:"H29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("H"),next:["G29"],text:"", move:0},
{id:"G29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("G"),next:["F29"],text:"", move:0},

// å·¦ãƒ«ãƒ¼ãƒˆï¼šF21 â†’ C21
{id:"E21",label:"â—‹",type:TYPE_NORMAL,row:21,col:col("E"),next:["D21"],text:"", move:0},
{id:"D21",label:"â—‹",type:TYPE_NORMAL,row:21,col:col("D"),next:["C21"],text:"", move:0},
{id:"C21",label:"â—‹",type:TYPE_NORMAL,row:21,col:col("C"),next:["C22"],text:"", move:0},

// å·¦ãƒ«ãƒ¼ãƒˆï¼šC21 â†’ C29ï¼ˆä¸‹ã¸ï¼‰
{id:"C22",label:"â—‹",type:TYPE_NORMAL,row:22,col:col("C"),next:["C23"],text:"", move:0},
{id:"C23",label:"â—‹",type:TYPE_NORMAL,row:23,col:col("C"),next:["C24"],text:"", move:0},
{id:"C24",label:"â—‹",type:TYPE_NORMAL,row:24,col:col("C"),next:["C25"],text:"", move:0},
{id:"C25",label:"â—‹",type:TYPE_NORMAL,row:25,col:col("C"),next:["C26"],text:"", move:0},
{id:"C26",label:"â—‹",type:TYPE_NORMAL,row:26,col:col("C"),next:["C27"],text:"", move:0},
{id:"C27",label:"â—‹",type:TYPE_NORMAL,row:27,col:col("C"),next:["C28"],text:"", move:0},
{id:"C28",label:"â—‹",type:TYPE_NORMAL,row:28,col:col("C"),next:["C29"],text:"", move:0},
{id:"C29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("C"),next:["D29"],text:"", move:0},

// å·¦ãƒ«ãƒ¼ãƒˆï¼šC29 â†’ F29ï¼ˆå³ã¸ï¼‰
{id:"D29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("D"),next:["E29"],text:"", move:0},
{id:"E29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("E"),next:["F29"],text:"", move:0},

// å…±é€šï¼šF29 â†’ F23ï¼ˆä¸Šã«æˆ»ã£ã¦ã‚´ãƒ¼ãƒ«ï¼‰
{id:"F29",label:"â—‹",type:TYPE_NORMAL,row:29,col:col("F"),next:["F28"],text:"", move:0},
{id:"F28",label:"â—‹",type:TYPE_NORMAL,row:28,col:col("F"),next:["F27"],text:"", move:0},
{id:"F27",label:"â—‹",type:TYPE_NORMAL,row:27,col:col("F"),next:["F26"],text:"", move:0},
{id:"F26",label:"â—‹",type:TYPE_NORMAL,row:26,col:col("F"),next:["F25"],text:"", move:0},
{id:"F25",label:"â—‹",type:TYPE_NORMAL,row:25,col:col("F"),next:["F24"],text:"", move:0},
{id:"F24",label:"â—‹",type:TYPE_NORMAL,row:24,col:col("F"),next:["F23"],text:"", move:0},
{id:"F23",label:"ã‚´",type:TYPE_GOAL,row:23,col:col("F"),next:["F23"],text:"ã‚´ãƒ¼ãƒ«"},
];


const idToIndex = {};
board.forEach((c,i)=>idToIndex[c.id]=i);

/*** â˜… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£ â˜… ***/

// 5äººã®åå‰ã‚’ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«æ±ºã‚ã‚‹
// 5äººã®åå‰ã‚’å…¥åŠ›
const players = [];
for (let i = 0; i < 5; i++) {
  const name = prompt(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, `P${i+1}`) || `P${i+1}`;
  players.push({ id: i, name });
}


// æ‰‹ç•ªé †ã‚’è‡ªåˆ†ã§æ±ºã‚ã‚‹
let turnOrder = [];

alert("æ¬¡ã®ç”»é¢ã§ã€æ‰‹ç•ªé †ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚\n1ç•ªç›®ã«å‹•ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰é †ã«é¸ã‚“ã§ã„ãã¾ã™ã€‚");

let remaining = [...players];

for (let pos = 0; pos < 5; pos++) {
  let msg = `æ‰‹ç•ª ${pos+1} ã«å‹•ããƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚\n\n`;
  remaining.forEach((p, i) => {
    msg += `${i+1}: ${p.name}\n`;
  });

  let choice = parseInt(prompt(msg)) - 1;
  if (isNaN(choice) || choice < 0 || choice >= remaining.length) choice = 0;

  turnOrder.push(remaining[choice].id);
  remaining.splice(choice, 1);
}

const textSlots = [];
const imageList = [];

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«50æ ç”Ÿæˆ
window.onload = () => {
  const container = document.getElementById("textSlots");

  // ä¿å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  const savedTexts = JSON.parse(localStorage.getItem("lifeGameTexts") || "[]");

  for (let i = 0; i < 50; i++) {
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = `ã‚¹ãƒ­ãƒƒãƒˆ ${i+1}`;
    input.style = "width:300px; margin:3px;";

    // â˜… ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¾©å…ƒ
    if (savedTexts[i]) {
      input.value = savedTexts[i];
    }

    container.appendChild(input);
    textSlots.push(input);
  }
};

document.getElementById("imgInput").addEventListener("change", (e) => {
  const files = e.target.files;

  for (let f of files) {
    const reader = new FileReader();
    reader.onload = () => {
      imageList.push(reader.result);

      // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
      const img = document.createElement("img");
      img.src = reader.result;
      img.width = 60;
      img.style = "border:1px solid #ccc;";
      document.getElementById("imgList").appendChild(img);
    };
    reader.readAsDataURL(f);
  }
});

function findCellBeforeGoal() {
  const goalIndex = board.findIndex(c => c.type === TYPE_GOAL);
  return board.findIndex(c => c.next && c.next.includes(board[goalIndex].id));
}

function shuffleAndAssign() {
  const beforeGoalIndex = findCellBeforeGoal();

  // æ–‡ç« ã‚’åé›†
  const texts = textSlots.map(i => i.value || "");

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  for (let i = texts.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [texts[i], texts[j]] = [texts[j], texts[i]];
  }

  // ç”»åƒã‚‚ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  for (let i = imageList.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [imageList[i], imageList[j]] = [imageList[j], imageList[i]];
  }

  // ãƒã‚¹ã¸å‰²ã‚Šå½“ã¦
  let tIndex = 0;
  let imgIndex = 0;

  board.forEach((cell, i) => {
    if (i === beforeGoalIndex) return; // â† ã‚´ãƒ¼ãƒ«1å€‹æ‰‹å‰ã¯å›ºå®š

    cell.text = texts[tIndex % texts.length];
    tIndex++;

    cell.image = imageList.length > 0 ? imageList[imgIndex % imageList.length] : null;
    imgIndex++;
  });
}

document.getElementById("startGameBtn").onclick = () => {

  // â˜… ä¿å­˜å‡¦ç†è¿½åŠ 
  const textsToSave = textSlots.map(input => input.value);
  localStorage.setItem("lifeGameTexts", JSON.stringify(textsToSave));

  shuffleAndAssign();
  document.getElementById("setupPanel").style.display = "none";
  renderBoard();
};


let currentTurnPos = 0;

// å…¨å“¡ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ï¼ˆA1ï¼‰ã«é…ç½®
const startIndex = idToIndex["A1"];
let playerIndex = players.map(()=> startIndex);

// ãƒ¯ãƒ¼ãƒ—è¨­å®šï¼ˆæ­¢ã¾ã£ãŸã¨ãã ã‘ç™ºå‹•ï¼‰
const WARP_FROM_ID = "F20";
const WARP_TO_ID   = "C11";

function currentPlayerId() {
  return turnOrder[currentTurnPos];
}

function updateTurnInfo() {
  const cp = currentPlayerId();
  const name = players[cp].name;
  const orderText = turnOrder.map(id => players[id].name).join(" â†’ ");
  document.getElementById("turnInfo").innerText =
    `æ‰‹ç•ªé †ï¼š${orderText}\nç¾åœ¨ã®æ‰‹ç•ªï¼š${name}`;
}



/*** â˜… æç”» â˜… ***/
function renderBoard(){
  const b = document.getElementById("board");
  b.innerHTML = "";
  board.forEach((c,i)=>{
    const d = document.createElement("div");
    d.className = "cell";
    d.style.gridRow = c.row;
    d.style.gridColumn = c.col;
    d.onclick = () => editCell(i);

    // ãƒ©ãƒ™ãƒ«
    const l = document.createElement("div");
    l.innerText = c.label;
    d.appendChild(l);

    // ã“ã®ãƒã‚¹ã«ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŸã¡
    const here = [];
    playerIndex.forEach((pos, pid)=>{
      if (pos === i) here.push(pid);
    });
    if (here.length > 0) {
      const badge = document.createElement("div");
      badge.className = "players-badge";
      here.forEach(pid=>{
        const dot = document.createElement("div");
        dot.className = `player-dot p${pid}`;
        dot.title = players[pid].name;
        badge.appendChild(dot);
      });
      d.appendChild(badge);
    }

    b.appendChild(d);
  });
}

/*** â˜… ã‚µã‚¤ã‚³ãƒ­ï¼†ç§»å‹• â˜… ***/
function rollDice() {
  const pid = currentPlayerId();

  // â˜… ä¼‘ã‚€ã‹ã©ã†ã‹ç¢ºèª
  const wantRest = confirm(`${players[pid].name} ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ä¼‘ã¿ã¾ã™ã‹ï¼Ÿ`);
  if (wantRest) {
    alert(`${players[pid].name} ã¯ã“ã®ã‚¿ãƒ¼ãƒ³ä¼‘ã¿ã¾ã™`);
    currentTurnPos = (currentTurnPos + 1) % players.length;
    updateTurnInfo();
    return;
  }

  const name = players[pid].name;

  const btn = document.querySelector("button");
  btn.disabled = true;

  const diceImg = document.getElementById("diceImg");

  // ğŸ² ã‚µã‚¤ã‚³ãƒ­ç”»åƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  let count = 0;
  const anim = setInterval(() => {
    const r = Math.floor(Math.random() * 6) + 1;
    diceImg.src = `dice${r}.png`;
    count++;
    if (count > 10) {
      clearInterval(anim);

      // ğŸ² æœ€çµ‚å‡ºç›®
      const dice = Math.floor(Math.random() * 6) + 1;
      diceImg.src = `dice${dice}.png`;

      // â˜… ã“ã“ã‹ã‚‰1ãƒã‚¹ãšã¤é€²ã‚€å‡¦ç†ã¸
      moveStepByStep(pid, dice, () => {

        // æ­¢ã¾ã£ãŸå¾Œã®ãƒ¯ãƒ¼ãƒ—åˆ¤å®š
        let stoppedCell = board[playerIndex[pid]];
        if (stoppedCell.id === WARP_FROM_ID) {
          playerIndex[pid] = idToIndex[WARP_TO_ID];
          stoppedCell = board[playerIndex[pid]];
          renderBoard();
        }

        document.getElementById("status").innerText =
          `${name} ã®ã‚µã‚¤ã‚³ãƒ­: ${dice} â†’ ${stoppedCell.id}`;

        // ã‚´ãƒ¼ãƒ«åˆ¤å®š
        if (stoppedCell.type === TYPE_GOAL) {
          alert(`${name} ãŒã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼`);
        }

        // æ‰‹ç•ªã‚’æ¬¡ã¸
        currentTurnPos = (currentTurnPos + 1) % players.length;
        updateTurnInfo();
        renderBoard();

        btn.disabled = false;
      });
    }
  }, 80);
}


function moveStepByStep(pid, steps, callback) {
if (steps <= 0) {

  let cell = board[playerIndex[pid]];
  const beforeGoalIndex = findCellBeforeGoal();

  // ã‚´ãƒ¼ãƒ«1å€‹å‰ãªã‚‰æ•—åŒ—
  if (board.indexOf(cell) === beforeGoalIndex) {
    const audio = new Audio("lose.mp3");
    audio.play();
    showLosePopup("lose.jpg");
    return;
  }

  // â˜… ãƒ¯ãƒ¼ãƒ—å‡¦ç†ã‚’ã“ã“ã«ç§»å‹•
  if (cell.id === WARP_FROM_ID) {
    playerIndex[pid] = idToIndex[WARP_TO_ID];
    renderBoard();
    cell = board[playerIndex[pid]];
  }

  showCellPopup(cell);

  // â˜… è¿½åŠ ç§»å‹•
  if (typeof cell.move === "number" && cell.move !== 0) {

    const extra = cell.move;
    cell.move = 0;

    setTimeout(() => {
      if (extra > 0) {
        moveStepByStep(pid, extra, callback);
      } else {
        moveStepBack(pid, Math.abs(extra), callback);
      }
    }, 800);

    return;
  }

  callback();
  return;
}

  let cell = board[playerIndex[pid]];

  if (cell.type === TYPE_BRANCH) {
    const opts = cell.next;
    let msg = `${players[pid].name} ã®åˆ†å²ã§ã™ã€‚ã©ã¡ã‚‰ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ\n`;
    opts.forEach((id,i)=>{
      msg += `${i+1}: ${id}\n`;
    });
    let c = parseInt(prompt(msg)) - 1;
    if (isNaN(c) || c < 0 || c >= opts.length) c = 0;
    playerIndex[pid] = idToIndex[opts[c]];
  } else {
    const nextIds = cell.next;
    if (!nextIds || nextIds.length === 0) {
      callback();
      return;
    }
    playerIndex[pid] = idToIndex[nextIds[0]];
  }

  // â˜… é€²ã‚€ã¨ãã®éŸ³ã¯ step.mp3 ã®ã¿
  const audio = new Audio("step.mp3");
  audio.play();

  renderBoard();

  setTimeout(()=>{
    moveStepByStep(pid, steps - 1, callback);
  }, 300);
}


function findCellBeforeGoal() {
  const goalIndex = board.findIndex(c => c.type === TYPE_GOAL);
  return board.findIndex(c => c.next && c.next.includes(board[goalIndex].id));
}

function showCellPopup(cell) {
  const popup = document.getElementById("cellPopup");
  const text = document.getElementById("popupText");
  const img  = document.getElementById("popupImg");

  text.textContent = cell.text || "";

  if (cell.image) {
    img.src = cell.image;
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }

  popup.style.display = "flex";

  // â˜… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸
  popup.classList.remove("show");
  void popup.offsetWidth; // â† å†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒªã‚»ãƒƒãƒˆ
  popup.classList.add("show");
}


function closeCellPopup() {
  document.getElementById("cellPopup").style.display = "none";
}



function showLosePopup(imgSrc) {
  const popup = document.getElementById("losePopup");
  const img = document.getElementById("loseImg");

  img.classList.remove("blink"); // å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
  img.src = imgSrc;

  popup.style.display = "block";

  // ç‚¹æ»…é–‹å§‹
  img.classList.add("blink");
}


document.addEventListener("keydown", (e) => {
  if (e.key === "d" || e.key === "D") {
    debugMove();
  }
});

function debugMove() {
  const pid = currentPlayerId();
  const id = prompt("ãƒ‡ãƒãƒƒã‚°ç§»å‹•ï¼šç§»å‹•ã—ãŸã„ãƒã‚¹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  if (!id || !idToIndex[id]) {
    alert("ãã®IDã®ãƒã‚¹ã¯å­˜åœ¨ã—ã¾ã›ã‚“");
    return;
  }

  // å¼·åˆ¶ç§»å‹•
  playerIndex[pid] = idToIndex[id];
  renderBoard();

  const cell = board[playerIndex[pid]];
  const beforeGoalIndex = findCellBeforeGoal();

  // â˜… ã‚´ãƒ¼ãƒ«1å€‹å‰ãªã‚‰å³æ•—åŒ—
  if (board.indexOf(cell) === beforeGoalIndex) {
    showLosePopup("lose.jpg");
    return;
  }

  // â˜… é€šå¸¸ã®ãƒã‚¹è¡¨ç¤º
  showCellPopup(cell);
}

function playEventVideo(src, onEnd) {
  const popup = document.getElementById("videoPopup");
  const video = document.getElementById("eventVideo");

  popup.style.display = "flex";
  video.src = src;
  video.play();

  video.onended = () => {
    popup.style.display = "none";
    video.src = "";
    if (onEnd) onEnd();
  };
}

function rollReverseDice() {
  const pid = currentPlayerId();
  const name = players[pid].name;

  const btn = document.querySelector("button");
  btn.disabled = true;

  const diceImg = document.getElementById("diceImg");

  // ğŸµ mp3 å†ç”Ÿï¼ˆé€šå¸¸ã‚µã‚¤ã‚³ãƒ­ã¨åŒã˜ï¼‰

  // ğŸ² ã‚µã‚¤ã‚³ãƒ­ç”»åƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Œå…¨ã«åŒã˜ï¼‰
  let count = 0;
  const anim = setInterval(() => {
    const r = Math.floor(Math.random() * 6) + 1;
    diceImg.src = `dice${r}.png`;
    count++;
    if (count > 10) {
      clearInterval(anim);

      // ğŸ² æœ€çµ‚å‡ºç›®
      const dice = Math.floor(Math.random() * 6) + 1;
      diceImg.src = `dice${dice}.png`;

      // â˜… ã“ã“ã‹ã‚‰1ãƒã‚¹ãšã¤ã€Œæˆ»ã‚‹ã€å‡¦ç†ã¸
      moveStepBack(pid, dice, () => {

        let stoppedCell = board[playerIndex[pid]];
        if (stoppedCell.id === WARP_FROM_ID) {
          playerIndex[pid] = idToIndex[WARP_TO_ID];
          stoppedCell = board[playerIndex[pid]];
          renderBoard();
        }

        document.getElementById("status").innerText =
          `${name} ã®é€†ã‚µã‚¤ã‚³ãƒ­: ${dice} â†’ ${stoppedCell.id}`;

        currentTurnPos = (currentTurnPos + 1) % players.length;
        updateTurnInfo();
        renderBoard();

        btn.disabled = false;
      });
    }
  }, 80);
}


function exportData() {
  const data = localStorage.getItem("lifeGameTexts");
  if (!data) return alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—");

  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "lifeGameTexts.json";
  a.click();

  URL.revokeObjectURL(url);
}

function moveStepBack(pid, steps, callback) {
  if (steps <= 0) {
    callback();
    return;
  }

  

  // â˜… 1ãƒã‚¹æˆ»ã‚‹ç›´å‰ã«åŠ¹æœéŸ³ï¼ˆé€²ã‚€ã¨ãã¨åŒã˜ä½ç½®ï¼‰
  const audio = new Audio("ppp.mp3");
  audio.play();

  const current = playerIndex[pid];

  // â˜… å‰ã®ãƒã‚¹ã‚’æ¢ã™
  let prevIndex = null;
  board.forEach((cell, idx) => {
    if (cell.next && cell.next.includes(board[current].id)) {
      prevIndex = idx;
    }
  });

  if (prevIndex === null) {
    callback();
    return;
  }

  // â˜… å®Ÿéš›ã«1ãƒã‚¹æˆ»ã‚‹
  playerIndex[pid] = prevIndex;
  renderBoard();

  // â˜… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
  setTimeout(() => {
    moveStepBack(pid, steps - 1, callback);
  }, 200);
}

function editCell(index) {
  const cell = board[index];

  const move = prompt(
    "ã“ã®ãƒã‚¹ã§ä½•ãƒã‚¹ç§»å‹•ã•ã›ã¾ã™ã‹ï¼Ÿ\nï¼ˆé€²ã‚€ãªã‚‰æ­£ã®æ•°ã€æˆ»ã‚‹ãªã‚‰è² ã®æ•°ã€ãªã—ã¯0ï¼‰",
    cell.move || 0
  );

  const num = parseInt(move);
  if (!isNaN(num)) {
    cell.move = num;
    alert(`${num}ãƒã‚¹ç§»å‹•ã«è¨­å®šã—ã¾ã—ãŸ`);
  }
}

function exportData() {
  const data = localStorage.getItem("lifeGameTexts");
  if (!data) return alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—");

  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "lifeGameTexts.json";
  a.click();

  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    localStorage.setItem("lifeGameTexts", e.target.result);
    alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„");
  };
  reader.readAsText(file);
}
/*** â˜… åˆæœŸæç”» â˜… ***/
updateTurnInfo();
renderBoard();
</script>

</body>
</html>
